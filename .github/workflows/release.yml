name: Release

on:
  release:
    types: [published]

jobs:
  test:
    name: Run Tests
    uses: ./.github/workflows/test.yml

  build-and-push:
    name: Build and Push Images
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push all images
        run: bash ./scripts/build/02-build-all.sh ${{ github.ref_name }}
        env:
          CONTAINER_REGISTRY: ghcr.io/ryanfaircloth/tinyolly
          DOCKER_BUILD_PUSH: "true"

      - name: Verify images
        run: |
          docker pull ghcr.io/ryanfaircloth/tinyolly/ui:${{ github.ref_name }}
          docker pull ghcr.io/ryanfaircloth/tinyolly/otlp-receiver:${{ github.ref_name }}
          docker pull ghcr.io/ryanfaircloth/tinyolly/opamp-server:${{ github.ref_name }}
  release-helm-chart:
    name: Release Helm Chart
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Login to GitHub Container Registry for Helm
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Update Chart version and image tags
        run: |
          cd charts/tinyolly

          # Extract version without 'v' prefix for chart version
          VERSION="${{ github.ref_name }}"
          CHART_VERSION="${VERSION#v}"

          # Update Chart.yaml version
          sed -i "s/^version: .*/version: ${CHART_VERSION}/" Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"${VERSION}\"/" Chart.yaml

          # Update image tags in values.yaml to use GHCR images
          sed -i "s|repository: .*tinyolly/ui|repository: ghcr.io/ryanfaircloth/tinyolly/ui|" values.yaml
          sed -i "s|repository: .*tinyolly/otlp-receiver|repository: ghcr.io/ryanfaircloth/tinyolly/otlp-receiver|" values.yaml
          sed -i "s|repository: .*tinyolly/opamp-server|repository: ghcr.io/ryanfaircloth/tinyolly/opamp-server|" values.yaml
          sed -i "s|tag: .*|tag: ${VERSION}|g" values.yaml

          echo "Updated Chart.yaml and values.yaml with version ${CHART_VERSION}"
          cat Chart.yaml | grep -E "^version:|^appVersion:"

      - name: Lint Helm chart
        run: |
          cd helm
          helm lint tinyolly

      - name: Package Helm chart
        run: |
          cd helm
          helm package tinyolly -d .

          VERSION="${{ github.ref_name }}"
          CHART_VERSION="${VERSION#v}"
          echo "CHART_PACKAGE=tinyolly-${CHART_VERSION}.tgz" >> $GITHUB_ENV

      - name: Push Helm chart to GHCR
        run: |
          cd helm
          helm push ${{ env.CHART_PACKAGE }} oci://ghcr.io/ryanfaircloth/charts

      - name: Verify chart push
        run: |
          VERSION="${{ github.ref_name }}"
          CHART_VERSION="${VERSION#v}"
          echo "âœ… Helm chart released: oci://ghcr.io/ryanfaircloth/charts/tinyolly:${CHART_VERSION}"
          echo "ðŸ“¦ Install with: helm install tinyolly oci://ghcr.io/ryanfaircloth/charts/tinyolly --version ${CHART_VERSION}"

      - name: Update ArgoCD Application with release version
        run: |
          VERSION="${{ github.ref_name }}"
          CHART_VERSION="${VERSION#v}"

          # Update ArgoCD Application to use GHCR chart and released version
          ARGOCD_APP_FILE=".kind/modules/main/argocd-applications/observability/tinyolly.yaml"

          # Update repoURL to GHCR
          sed -i "s|repoURL: .*|repoURL: 'oci://ghcr.io/ryanfaircloth/charts'|" "$ARGOCD_APP_FILE"

          # Update targetRevision to the release version
          sed -i "s|targetRevision: .*|targetRevision: ${CHART_VERSION}|" "$ARGOCD_APP_FILE"

          # Update image repositories to GHCR and tags to release version
          sed -i "s|repository: .*tinyolly/ui|repository: ghcr.io/ryanfaircloth/tinyolly/ui|" "$ARGOCD_APP_FILE"
          sed -i "s|repository: .*tinyolly/otlp-receiver|repository: ghcr.io/ryanfaircloth/tinyolly/otlp-receiver|" "$ARGOCD_APP_FILE"
          sed -i "s|repository: .*tinyolly/opamp-server|repository: ghcr.io/ryanfaircloth/tinyolly/opamp-server|" "$ARGOCD_APP_FILE"

          # Update all image tags to the release version
          sed -i "/tag:/c\            tag: ${VERSION}" "$ARGOCD_APP_FILE"

          echo "Updated ArgoCD Application:"
          grep -A 2 "repoURL:\|targetRevision:\|repository:\|tag:" "$ARGOCD_APP_FILE" || true

      - name: Commit and push ArgoCD Application updates
        run: |
          VERSION="${{ github.ref_name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .kind/modules/main/argocd-applications/observability/tinyolly.yaml
          git add charts/tinyolly/Chart.yaml
          git add charts/tinyolly/values.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update ArgoCD Application and Helm chart to ${VERSION} [skip ci]"
            git push origin HEAD:main
            echo "âœ… Committed and pushed ArgoCD Application updates"
          fi
