name: release-please

on:
  push:
    branches:
      - main
      - develop
      - next-release
      - next-release-major
      - copilot/next-release # Current testing branch
  workflow_dispatch:
    inputs:
      prerelease:
        description: "Create pre-release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      is_prerelease: ${{ steps.check_branch.outputs.is_prerelease }}
      # App releases
      ollyscale_released: ${{ steps.release.outputs['apps/ollyscale--release_created'] }}
      ollyscale_version: ${{ steps.release.outputs['apps/ollyscale--version'] }}
      ollyscale_ui_released: ${{ steps.release.outputs['apps/ollyscale-ui--release_created'] }}
      ollyscale_ui_version: ${{ steps.release.outputs['apps/ollyscale-ui--version'] }}
      opamp_server_released: ${{ steps.release.outputs['apps/opamp-server--release_created'] }}
      opamp_server_version: ${{ steps.release.outputs['apps/opamp-server--version'] }}
      demo_released: ${{ steps.release.outputs['apps/demo--release_created'] }}
      demo_version: ${{ steps.release.outputs['apps/demo--version'] }}
      demo_otel_agent_released: ${{ steps.release.outputs['apps/demo-otel-agent--release_created'] }}
      demo_otel_agent_version: ${{ steps.release.outputs['apps/demo-otel-agent--version'] }}
      # Chart releases
      chart_ollyscale_released: ${{ steps.release.outputs['charts/ollyscale--release_created'] }}
      chart_ollyscale_version: ${{ steps.release.outputs['charts/ollyscale--version'] }}
      chart_ollyscale_demos_released: ${{ steps.release.outputs['charts/ollyscale-demos--release_created'] }}
      chart_ollyscale_demos_version: ${{ steps.release.outputs['charts/ollyscale-demos--version'] }}
      chart_ollyscale_otel_agent_released: ${{ steps.release.outputs['charts/ollyscale-otel-agent--release_created'] }}
      chart_ollyscale_otel_agent_version: ${{ steps.release.outputs['charts/ollyscale-otel-agent--version'] }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if this is a pre-release branch
        id: check_branch
        run: |
          # Main is stable release, all others are pre-releases
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ inputs.prerelease }}" != "true" ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ Building as stable release"
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Building as pre-release (branch: ${GITHUB_REF#refs/heads/})"
          fi

      - name: Run release-please
        id: release
        uses: ryanfaircloth/release-please-action@test/fork-dependency
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          target-branch: ${{ github.ref_name }}

  # Container builds
  build-ollyscale:
    needs: release-please
    if: needs.release-please.outputs.ollyscale_released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/ryanfaircloth/ollyscale/ollyscale
          tags: |
            type=semver,pattern={{version}},value=${{ needs.release-please.outputs.ollyscale_version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.release-please.outputs.ollyscale_version }}
            type=semver,pattern={{major}},value=${{ needs.release-please.outputs.ollyscale_version }}
            type=raw,value=latest,enable=${{ needs.release-please.outputs.is_prerelease != 'true' }}
          labels: |
            org.opencontainers.image.version=${{ needs.release-please.outputs.ollyscale_version }}
            org.opencontainers.image.prerelease=${{ needs.release-please.outputs.is_prerelease }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: apps/ollyscale
          file: apps/ollyscale/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-ollyscale-ui:
    needs: release-please
    if: needs.release-please.outputs.ollyscale_ui_released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/ryanfaircloth/ollyscale/ollyscale-ui
          tags: |
            type=semver,pattern={{version}},value=${{ needs.release-please.outputs.ollyscale_ui_version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.release-please.outputs.ollyscale_ui_version }}
            type=semver,pattern={{major}},value=${{ needs.release-please.outputs.ollyscale_ui_version }}
            type=raw,value=latest,enable=${{ needs.release-please.outputs.is_prerelease != 'true' }}
          labels: |
            org.opencontainers.image.version=${{ needs.release-please.outputs.ollyscale_ui_version }}
            org.opencontainers.image.prerelease=${{ needs.release-please.outputs.is_prerelease }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: apps/ollyscale-ui
          file: apps/ollyscale-ui/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-opamp-server:
    needs: release-please
    if: needs.release-please.outputs.opamp_server_released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/ryanfaircloth/ollyscale/opamp-server
          tags: |
            type=semver,pattern={{version}},value=${{ needs.release-please.outputs.opamp_server_version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.release-please.outputs.opamp_server_version }}
            type=semver,pattern={{major}},value=${{ needs.release-please.outputs.opamp_server_version }}
            type=raw,value=latest,enable=${{ needs.release-please.outputs.is_prerelease != 'true' }}
          labels: |
            org.opencontainers.image.version=${{ needs.release-please.outputs.opamp_server_version }}
            org.opencontainers.image.prerelease=${{ needs.release-please.outputs.is_prerelease }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: apps/opamp-server
          file: apps/opamp-server/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-demo:
    needs: release-please
    if: needs.release-please.outputs.demo_released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/ryanfaircloth/ollyscale/demo
          tags: |
            type=semver,pattern={{version}},value=${{ needs.release-please.outputs.demo_version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.release-please.outputs.demo_version }}
            type=semver,pattern={{major}},value=${{ needs.release-please.outputs.demo_version }}
            type=raw,value=latest,enable=${{ needs.release-please.outputs.is_prerelease != 'true' }}
          labels: |
            org.opencontainers.image.version=${{ needs.release-please.outputs.demo_version }}
            org.opencontainers.image.prerelease=${{ needs.release-please.outputs.is_prerelease }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: apps/demo
          file: apps/demo/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-demo-otel-agent:
    needs: release-please
    if: needs.release-please.outputs.demo_otel_agent_released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/ryanfaircloth/ollyscale/demo-otel-agent
          tags: |
            type=semver,pattern={{version}},value=${{ needs.release-please.outputs.demo_otel_agent_version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.release-please.outputs.demo_otel_agent_version }}
            type=semver,pattern={{major}},value=${{ needs.release-please.outputs.demo_otel_agent_version }}
            type=raw,value=latest,enable=${{ needs.release-please.outputs.is_prerelease != 'true' }}
          labels: |
            org.opencontainers.image.version=${{ needs.release-please.outputs.demo_otel_agent_version }}
            org.opencontainers.image.prerelease=${{ needs.release-please.outputs.is_prerelease }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: apps/demo-otel-agent
          file: apps/demo-otel-agent/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Helm chart publishing (depends on container builds)
  publish-chart-ollyscale:
    needs: [release-please, build-ollyscale, build-ollyscale-ui, build-opamp-server]
    if: |
      always() &&
      needs.release-please.outputs.chart_ollyscale_released == 'true' &&
      (needs.build-ollyscale.result == 'success' || needs.build-ollyscale.result == 'skipped') &&
      (needs.build-ollyscale-ui.result == 'success' || needs.build-ollyscale-ui.result == 'skipped') &&
      (needs.build-opamp-server.result == 'success' || needs.build-opamp-server.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Package and push Helm chart
        run: |
          cd charts/ollyscale
          helm package .
          helm push ollyscale-${{ needs.release-please.outputs.chart_ollyscale_version }}.tgz oci://ghcr.io/ryanfaircloth/ollyscale/charts

  publish-chart-ollyscale-demos:
    needs: [release-please, build-demo]
    if: |
      always() &&
      needs.release-please.outputs.chart_ollyscale_demos_released == 'true' &&
      (needs.build-demo.result == 'success' || needs.build-demo.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Package and push Helm chart
        run: |
          cd charts/ollyscale-demos
          helm package .
          helm push ollyscale-demos-${{ needs.release-please.outputs.chart_ollyscale_demos_version }}.tgz oci://ghcr.io/ryanfaircloth/ollyscale/charts

  publish-chart-ollyscale-otel-agent:
    needs: [release-please, build-demo-otel-agent]
    if: |
      always() &&
      needs.release-please.outputs.chart_ollyscale_otel_agent_released == 'true' &&
      (needs.build-demo-otel-agent.result == 'success' || needs.build-demo-otel-agent.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Package and push Helm chart
        run: |
          cd charts/ollyscale-otel-agent
          helm package .
          helm push ollyscale-otel-agent-${{ needs.release-please.outputs.chart_ollyscale_otel_agent_version }}.tgz oci://ghcr.io/ryanfaircloth/ollyscale/charts
