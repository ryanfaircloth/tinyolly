{{- if .Values.instrumentation.enabled -}}
apiVersion: opentelemetry.io/v1alpha1
kind: Instrumentation
metadata:
  name: {{ .Values.instrumentation.name | default "python-instrumentation" }}
  namespace: {{ .Values.instrumentation.namespace | default .Release.Namespace }}
  labels:
    {{- include "tinyolly.labels" . | nindent 4 }}
    app.kubernetes.io/component: instrumentation
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  # Collector endpoint where telemetry will be exported
  exporter:
    endpoint: {{ .Values.instrumentation.exporter.endpoint | default (printf "http://agent-collector.%s.svc.cluster.local:4318" .Values.instrumentation.namespace) }}
  
  # Propagators configuration
  propagators:
    {{- toYaml .Values.instrumentation.propagators | nindent 4 }}
  
  # Resource attributes applied to all telemetry
  {{- if .Values.instrumentation.resource }}
  resource:
    {{- if .Values.instrumentation.resource.addK8sUIDAttributes }}
    addK8sUIDAttributes: {{ .Values.instrumentation.resource.addK8sUIDAttributes }}
    {{- end }}
    {{- if .Values.instrumentation.resource.attributes }}
    attributes:
      {{- toYaml .Values.instrumentation.resource.attributes | nindent 6 }}
    {{- end }}
  {{- end }}
  
  # Python auto-instrumentation configuration
  python:
    {{- if .Values.instrumentation.python.image }}
    image: {{ .Values.instrumentation.python.image.repository }}:{{ .Values.instrumentation.python.image.tag }}
    {{- end }}
    {{- if .Values.instrumentation.python.env }}
    env:
      {{- toYaml .Values.instrumentation.python.env | nindent 6 }}
    {{- end }}
    {{- if .Values.instrumentation.python.resources }}
    resourceRequirements:
      {{- toYaml .Values.instrumentation.python.resources | nindent 6 }}
    {{- end }}
{{- end }}
