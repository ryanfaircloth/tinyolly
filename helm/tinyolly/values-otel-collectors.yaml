# Example values for enabling OpenTelemetry Agent and Gateway Collectors
# Copy relevant sections to your values.yaml or use as override with:
#   helm upgrade tinyolly . -f values-otel-collectors.yaml
#
# Architecture:
# 1. Agent Collector (daemonset) - Collects logs from nodes, enriches with K8s metadata
# 2. Gateway Collector (deployment) - Receives from agents, tail samples, generates metrics, forwards to TinyOlly
# 3. TinyOlly OTLP Receiver - Stores telemetry in Redis
#
# Flow: App/Envoy -> Agent -> Gateway -> TinyOlly OTLP Receiver -> Redis

agentCollector:
  enabled: true
  namespace: opentelemetry-operator-system
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      filelog:
        include:
          - /var/log/pods/*/*/*.log
        exclude:
          - /var/log/pods/opentelemetry-operator-system_*/*/*.log
          - /var/log/pods/flux-system_*/*/*.log
        start_at: end
        include_file_path: true
        include_file_name: false
        operators:
          - type: recombine
            id: multiline-merger
            combine_field: body
            is_first_entry: 'body matches "^\\S"'
          - type: container
            id: container-parser
          - type: json_parser
            id: json-parser
            parse_from: body
            parse_to: attributes
            on_error: send
          - type: severity_parser
            id: severity-parser
            parse_from: attributes.level
            on_error: send
          - type: severity_parser
            id: severity-parser-alt
            parse_from: attributes.log_level
            on_error: send
          - type: remove
            id: remove-level
            field: attributes.level
            if: attributes.level != nil
          - type: remove
            id: remove-log-level
            field: attributes.log_level
            if: attributes.log_level != nil
          - type: move
            id: map-legacy-app-to-service-name
            from: attributes.legacy.app
            to: attributes.service.name
            if: 'attributes.legacy.app != nil and attributes.service.name == nil'
          - type: move
            id: map-legacy-version-to-service-version
            from: attributes.legacy.version
            to: attributes.service.version
            if: 'attributes.legacy.version != nil and attributes.service.version == nil'
          - type: remove
            id: remove-legacy-app
            field: attributes.legacy.app
            if: attributes.legacy.app != nil
          - type: remove
            id: remove-legacy-version
            field: attributes.legacy.version
            if: attributes.legacy.version != nil
          - type: regex_parser
            id: parse-w3c-trace-context-lower
            if: attributes.traceparent != nil
            parse_from: attributes.traceparent
            regex: '^(?P<version>[0-9a-f]{2})-(?P<trace_id>[0-9a-f]{32})-(?P<span_id>[0-9a-f]{16})-(?P<trace_flags>[0-9a-f]{2})$'
            parse_to: attributes.w3c_trace
          - type: regex_parser
            id: parse-w3c-trace-context-upper
            if: attributes.Traceparent != nil
            parse_from: attributes.Traceparent
            regex: '^(?P<version>[0-9a-f]{2})-(?P<trace_id>[0-9a-f]{32})-(?P<span_id>[0-9a-f]{16})-(?P<trace_flags>[0-9a-f]{2})$'
            parse_to: attributes.w3c_trace
          - type: move
            id: set-trace-id-from-w3c
            from: attributes.w3c_trace.trace_id
            to: resource.trace_id
            if: attributes.w3c_trace.trace_id != nil
          - type: move
            id: set-span-id-from-w3c
            from: attributes.w3c_trace.span_id
            to: resource.span_id
            if: attributes.w3c_trace.span_id != nil
          - type: remove
            id: remove-w3c-trace-temp
            field: attributes.w3c_trace
            if: attributes.w3c_trace != nil
          - type: trace_parser
            id: set-trace-correlation
            if: resource.trace_id != nil
            trace_id:
              parse_from: resource.trace_id
            span_id:
              parse_from: resource.span_id
          - type: remove
            id: remove-traceparent
            field: attributes.traceparent
            if: attributes.traceparent != nil
          - type: remove
            id: remove-Traceparent
            field: attributes.Traceparent
            if: attributes.Traceparent != nil
          - type: remove
            id: remove-resource-trace-id
            field: resource.trace_id
            if: resource.trace_id != nil
          - type: remove
            id: remove-resource-span-id
            field: resource.span_id
            if: resource.span_id != nil
          - type: remove
            id: remove-version
            field: attributes.version
            if: 'attributes.version != nil and attributes.version matches "^[0-9a-f]{2}$"'
          - type: move
            id: extract-msg-field
            from: attributes.msg
            to: body
            if: attributes.msg != nil
          - type: move
            id: extract-message-field
            from: attributes.message
            to: body
            if: attributes.message != nil
        storage: file_storage
    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      transform/preserve-service:
        error_mode: ignore
        log_statements:
          - context: resource
            statements:
              - set(attributes["_preserve_service_name"], "true") where attributes["service.name"] != nil and not IsMatch(attributes["service.name"], "^(unknown_service|kubernetes-logs|otel-collector|default|)$")
      k8sattributes:
        auth_type: "serviceAccount"
        passthrough: false
        filter:
          node_from_env_var: KUBE_NODE_NAME
        extract:
          metadata:
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.deployment.name
            - k8s.namespace.name
            - k8s.node.name
            - k8s.pod.start_time
          labels:
            - tag_name: k8s.app.name
              key: app.kubernetes.io/name
              from: pod
            - tag_name: k8s.app.version
              key: app.kubernetes.io/version
              from: pod
            - tag_name: k8s.app.component
              key: app.kubernetes.io/component
              from: pod
            - tag_name: k8s.app.instance
              key: app.kubernetes.io/instance
              from: pod
            - tag_name: k8s.legacy.app
              key: app
              from: pod
            - tag_name: k8s.legacy.version
              key: version
              from: pod
          annotations:
            - tag_name: k8s.deployment_config
              key: deployment.kubernetes.io/config-hash
              from: pod
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: resource_attribute
                name: k8s.pod.name
              - from: resource_attribute
                name: k8s.namespace.name
          - sources:
              - from: connection
      resource/service-naming:
        attributes:
          - key: service.name
            from_attribute: k8s.app.name
            action: insert
          - key: service.name
            from_attribute: k8s.legacy.app
            action: insert
          - key: service.version
            from_attribute: k8s.app.version
            action: upsert
          - key: service.version
            from_attribute: k8s.legacy.version
            action: upsert
          - key: service.component
            from_attribute: k8s.app.component
            action: upsert
          - key: service.instance.id
            from_attribute: k8s.app.instance
            action: upsert
          - key: deployment.environment
            value: dev
            action: upsert
          - key: service.name
            value: kubernetes-logs
            action: insert
      transform/fix-service-names:
        error_mode: ignore
        trace_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], attributes["service.component"]) where attributes["service.name"] == "kubernetes-logs" and attributes["service.component"] != nil
        log_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], attributes["service.component"]) where attributes["service.name"] == "kubernetes-logs" and attributes["service.component"] != nil
        metric_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], attributes["service.component"]) where attributes["service.name"] == "kubernetes-logs" and attributes["service.component"] != nil
      attributes/cleanup:
        actions:
          - key: _preserve_service_name
            action: delete
          - key: k8s.app.name
            action: delete
          - key: k8s.app.version
            action: delete
          - key: k8s.app.component
            action: delete
          - key: k8s.app.instance
            action: delete
          - key: k8s.legacy.app
            action: delete
          - key: k8s.legacy.version
            action: delete
    extensions:
      file_storage:
        directory: /otel-logs-storage
        timeout: 10s
        create_directory: true
    exporters:
      loadbalancing/gateway:
        resolver:
          dns:
            hostname: gateway-collector-headless.opentelemetry-operator-system.svc.cluster.local
            port: "4317"
        protocol:
          otlp:
            tls:
              insecure: true
            sending_queue:
              enabled: true
              num_consumers: 4
              queue_size: 100
            retry_on_failure:
              enabled: true
              initial_interval: 10ms
              max_interval: 1m
              max_elapsed_time: 10m
      otlp/to:
        endpoint: tinyolly-otlp-receiver.tinyolly.svc.cluster.local:4343
        tls:
          insecure: true
        sending_queue:
          enabled: true
          num_consumers: 4
          queue_size: 100
        retry_on_failure:
          enabled: true
          initial_interval: 10ms
          max_interval: 1m
          max_elapsed_time: 10m
    service:
      extensions: [file_storage]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [transform/preserve-service, k8sattributes, resource/service-naming, transform/fix-service-names, attributes/cleanup, batch]
          exporters: [loadbalancing/gateway]
        metrics:
          receivers: [otlp]
          processors: [transform/preserve-service, k8sattributes, resource/service-naming, transform/fix-service-names, attributes/cleanup, batch]
          exporters: [loadbalancing/gateway]
        logs:
          receivers: [filelog, otlp]
          processors: [transform/preserve-service, k8sattributes, resource/service-naming, transform/fix-service-names, attributes/cleanup, batch]
          exporters: [loadbalancing/gateway]

gatewayCollector:
  enabled: true
  namespace: opentelemetry-operator-system
  replicas: 1
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 200m
      memory: 256Mi
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      tail_sampling:
        decision_wait: 10s
        num_traces: 50000
        expected_new_traces_per_sec: 10
        policies:
          - name: sample_all
            type: always_sample
      transform/preserve-service:
        error_mode: ignore
        trace_statements:
          - context: resource
            statements:
              - set(attributes["_preserve_service_name"], "true") where attributes["service.name"] != nil and not IsMatch(attributes["service.name"], "^(unknown_service|kubernetes-logs|otel-collector|gateway|agent|default|)$")
      transform/envoy-service-name:
        error_mode: ignore
        trace_statements:
          - context: span
            conditions:
              - resource.attributes["telemetry.sdk.name"] == "envoy"
            statements:
              - set(resource.attributes["service.name"], Split(attributes["upstream_cluster"], "/")[2]) where attributes["upstream_cluster"] != nil and IsMatch(attributes["upstream_cluster"], "^httproute/[^/]+/[^/]+/rule/\\d+$")
              - set(attributes["http.route"], Split(attributes["upstream_cluster"], "/")[2]) where attributes["upstream_cluster"] != nil and IsMatch(attributes["upstream_cluster"], "^httproute/[^/]+/[^/]+/rule/\\d+$")
              - set(resource.attributes["service.name"], Split(attributes["upstream_cluster"], "/")[2]) where attributes["upstream_cluster"] != nil and IsMatch(attributes["upstream_cluster"], "^securitypolicy/[^/]+/[^/]+/extauth/\\d+$")
              - set(attributes["http.route"], Split(attributes["upstream_cluster"], "/")[2]) where attributes["upstream_cluster"] != nil and IsMatch(attributes["upstream_cluster"], "^securitypolicy/[^/]+/[^/]+/extauth/\\d+$")
              - set(resource.attributes["service.name"], Split(Split(attributes["http.url"], "://")[1], ".")[0]) where attributes["http.url"] != nil and resource.attributes["service.name"] == "envoy"
              - set(attributes["http.route"], Split(Split(attributes["http.url"], "://")[1], ".")[0]) where attributes["http.url"] != nil and attributes["http.route"] == nil
      transform/service_names:
        error_mode: ignore
        trace_statements:
          - context: span
            statements:
              - set(resource.attributes["service.name"], Split(attributes["upstream_cluster"], "/")[2]) where attributes["upstream_cluster"] != nil and IsMatch(attributes["upstream_cluster"], "^httproute/[^/]+/[^/]+/rule/\\d+$") and resource.attributes["_preserve_service_name"] == nil
              - set(resource.attributes["service.name"], Split(attributes["upstream_cluster"], "/")[2]) where attributes["upstream_cluster"] != nil and IsMatch(attributes["upstream_cluster"], "^securitypolicy/[^/]+/[^/]+/extauth/\\d+$") and resource.attributes["_preserve_service_name"] == nil
      k8sattributes:
        auth_type: "serviceAccount"
        passthrough: false
        extract:
          metadata:
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.deployment.name
            - k8s.namespace.name
            - k8s.node.name
            - k8s.pod.start_time
          labels:
            - tag_name: k8s.app.name
              key: app.kubernetes.io/name
              from: pod
            - tag_name: k8s.app.version
              key: app.kubernetes.io/version
              from: pod
            - tag_name: k8s.app.component
              key: app.kubernetes.io/component
              from: pod
            - tag_name: k8s.app.instance
              key: app.kubernetes.io/instance
              from: pod
            - tag_name: k8s.legacy.app
              key: app
              from: pod
            - tag_name: k8s.legacy.version
              key: version
              from: pod
          annotations:
            - tag_name: k8s.deployment_config
              key: deployment.kubernetes.io/config-hash
              from: pod
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: resource_attribute
                name: k8s.pod.name
              - from: resource_attribute
                name: k8s.namespace.name
      resource/service-naming:
        attributes:
          - key: service.name
            from_attribute: k8s.app.name
            action: insert
          - key: service.name
            from_attribute: k8s.legacy.app
            action: insert
          - key: service.version
            from_attribute: k8s.app.version
            action: upsert
          - key: service.version
            from_attribute: k8s.legacy.version
            action: upsert
      transform/fix-service-names:
        error_mode: ignore
        trace_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], attributes["service.component"]) where attributes["service.name"] == "kubernetes-logs" and attributes["service.component"] != nil
        log_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], attributes["service.component"]) where attributes["service.name"] == "kubernetes-logs" and attributes["service.component"] != nil
        metric_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], attributes["service.component"]) where attributes["service.name"] == "kubernetes-logs" and attributes["service.component"] != nil
      attributes/cleanup:
        actions:
          - key: _preserve_service_name
            action: delete
          - key: k8s.app.name
            action: delete
          - key: k8s.app.version
            action: delete
          - key: k8s.app.component
            action: delete
          - key: k8s.app.instance
            action: delete
          - key: k8s.legacy.app
            action: delete
          - key: k8s.legacy.version
            action: delete
    connectors:
      spanmetrics:
        histogram:
          explicit:
            buckets: [1ms, 4ms, 10ms, 20ms, 50ms, 100ms, 200ms, 500ms, 1s, 2s, 5s]
        dimensions:
          - name: http.method
          - name: http.status_code
        dimensions_cache_size: 1000
        aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
        metrics_flush_interval: 15s
        metrics_expiration: 5m
    exporters:
      otlp/to:
        endpoint: tinyolly-otlp-receiver.tinyolly.svc.cluster.local:4343
        tls:
          insecure: true
        sending_queue:
          enabled: true
          num_consumers: 4
          queue_size: 100
        retry_on_failure:
          enabled: true
          initial_interval: 10ms
          max_interval: 1m
          max_elapsed_time: 10m
    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [transform/preserve-service, tail_sampling, transform/envoy-service-name, transform/service_names, k8sattributes, resource/service-naming, transform/fix-service-names, attributes/cleanup, batch]
          exporters: [spanmetrics, otlp/to]
        metrics:
          receivers: [spanmetrics, otlp]
          processors: [transform/preserve-service, k8sattributes, resource/service-naming, transform/fix-service-names, attributes/cleanup, batch]
          exporters: [otlp/to]
        logs:
          receivers: [otlp]
          processors: [transform/preserve-service, k8sattributes, resource/service-naming, transform/fix-service-names, attributes/cleanup, batch]
          exporters: [otlp/to]

instrumentation:
  enabled: true
  name: python-instrumentation
  namespace: opentelemetry-operator-system
  exporter:
    endpoint: http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318
  propagators:
    - tracecontext
    - baggage
  resource:
    addK8sUIDAttributes: true
    attributes:
      deployment.environment: "development"
  python:
    # Optional: override image version
    # image:
    #   repository: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-python
    #   tag: 0.60b0
    env:
      - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
        value: "true"
      - name: OTEL_PYTHON_LOGGING_INJECTION_ENABLED
        value: "true"
      - name: OTEL_PYTHON_LOG_LEVEL
        value: "INFO"
      - name: OTEL_PYTHON_LOG_CORRELATION
        value: "true"
      - name: OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_REQUEST
        value: "content-.*,x-.*"
      - name: OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_RESPONSE
        value: "content-.*,x-.*"
      - name: OTEL_PYTHON_EXCLUDED_URLS
        value: "/health,/metrics,ready"
