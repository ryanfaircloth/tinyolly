apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ollyscale.fullname" . }}-otelcol-templates
  labels:
    {{- include "ollyscale.labels" . | nindent 4 }}
data:
  prometheus-remote-write.yaml: |
    # Configuration with Prometheus Remote Write receiver
    # Extends the default config to accept Prometheus remote write metrics
    # in addition to OTLP. Useful for integrating Prometheus exporters and
    # Prometheus-compatible clients that use the Remote Write protocol.
    #
    # The prometheusremotewrite receiver accepts metrics via Prometheus Remote Write v2 protocol.
    # Clients should configure their remote_write endpoint to:
    #   http://<collector-host>:19291/api/v1/write
    #
    # Reference: https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/prometheusremotewritereceiver

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      # Prometheus Remote Write receiver
      # Receives metrics via Prometheus Remote Write protocol
      # Clients should send to: http://<collector-host>:19291/api/v1/write
      # Reference: https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/prometheusremotewritereceiver
      prometheusremotewrite:
        endpoint: "0.0.0.0:19291"
        # Optional: configure authentication
        # auth:
        #   authenticator: basicauth
        # Optional: configure TLS
        # tls:
        #   cert_file: /path/to/cert.pem
        #   key_file: /path/to/key.pem

    extensions:
      opamp:
        server:
          ws:
            endpoint: ws://{{ include "ollyscale.opampServer.name" . }}:4320/v1/opamp

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024

    connectors:
      spanmetrics:
        histogram:
          explicit:
            buckets: [1ms, 4ms, 10ms, 20ms, 50ms, 100ms, 200ms, 500ms, 1s, 2s, 5s]
        dimensions:
          - name: http.method
          - name: http.status_code
        dimensions_cache_size: 1000
        aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
        metrics_flush_interval: 15s
        metrics_expiration: 5m

    exporters:
      debug:
        verbosity: detailed

      otlp:
        endpoint: "{{ include "ollyscale.otlpReceiver.name" . }}:4343"
        tls:
          insecure: true

    service:
      extensions: [opamp]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp, spanmetrics]

        metrics:
          # Include both OTLP metrics and Prometheus remote write metrics
          receivers: [otlp, prometheusremotewrite, spanmetrics]
          processors: [batch]
          exporters: [debug, otlp]

        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp]
  incorrect.yaml: |
    # Example of an INCORRECT configuration to test ollyScale UI error handling
    # This config contains intentional errors: invalid YAML syntax, missing required sections,
    # invalid processor names, and pipeline misconfigurations.

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      # Invalid receiver configuration - missing required fields
      prometheus:
        # Missing scrape_configs or other required fields

    extensions:
      opamp:
        server:
          ws:
            endpoint: ws://{{ include "ollyscale.opampServer.name" . }}:4320/v1/opamp

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      # Invalid processor - this processor doesn't exist
      invalid_processor:
        some_field: value
      # Malformed processor - invalid YAML structure
      attributes:
        actions:
          - key: environment
            value: development
            action: upsert
          # Missing proper list termination - will cause validation issues

    exporters:
      debug:
        verbosity: detailed
      otlp:
        endpoint: "{{ include "ollyscale.otlpReceiver.name" . }}:4343"
        tls:
          insecure: true
      # Invalid exporter - missing required configuration
      nonexistent_exporter:
        # Missing required fields

    service:
      extensions: [opamp]
      pipelines:
        traces:
          receivers: [otlp, prometheus]  # prometheus receiver doesn't support traces
          processors: [invalid_processor, batch]  # invalid processor
          exporters: [debug, otlp, nonexistent_exporter]  # nonexistent exporter
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp]
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp]
        # Invalid pipeline - missing required fields (this will fail validation)
        invalid_pipeline:
          # Missing receivers, processors, and exporters
